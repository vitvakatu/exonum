# EXONUM UTXO

schema.rs - exonum/src/blockchain/schema.rs
consensus.rs - exonum/src/blockchain/consensus.rs
mod.rs - exonum/src/blockchain/mod.rs
(Как оказалось можно избежать изменения кода backend-а проекта)

Цель: создать список непотраченных выходов транзакций

Так как тразакция перевода денег содержит хэш транзакции, в которой отправителю принадлежит выход, то необходимо отслеживать корректность обращения к таким транзакциям. Стоит отдельно заметить, что в одной транзакции более одного выхода не может принадлежать одному и тому же человеку. Чтобы никакая транзакция не использовалась более одного раза. Так же и транзакции с некорректными хэшами удалялись из пула.

Для этого создается KeySetIndex "unspend_transactions" в schema.rs, который хранит в себе все транзакции, которые завершились удачным commit и чей output ещё не был использван. Cоздается это множество в обычном и _mut варианте для его последующих изменений. Поддерживает операции вставки по RawMessage нужной транзакции и удаления по хэшу. Ещё пишется функция reject_transaction, позовляющая коррктно удалять "плохую" транзакцию из пулла (помимо просто удаления транзакции из пула необходимо ещё уменьшить размер пула и удалить транзакции из списка всех транзакций). 

Далее переходим к consensus.rs. Как только приходит новая транзакция, которую надо занести в пул, она сразу же заносится в неиспользованные выходы. Делается это независимо от её корректности. Проверка транзакций на корректность происходит в той же функции, что и отбор транзакций из пула на commit. Обусловлено это тем, что одновременно с исключением некорректной транзакции из пула её легко исключить из неиспользованных транзакций. 

Теперь конкретнее про отбор транзакций на commit. Рассматривается весь текущий пул транзакций как вектор из транзакций(точнее из хэшей этих транзакций). Начиная с первого элемента, циклом рассматривается каждый хэш. По нему запрашивается RawMessage транзакции и он далее обрабатывается. Если транзакция 1 и 2 типа (создание кошелька или пополнение), то она заносится в итоговый вектор без проверок. Если транзакция 0 или 3 типа(перевод 1->1 или 2->2 (возможно реализовать n->n с использованием массивов)), то она проверяется на корректность. Для этого из транзакции извлекается хэши всех транзакций, на которые она ссылается. После этого проверяется содержатся ли они в неиспользованных выходах. Если хотя бы один из них не содержится, то транзакция признается некорректной и отклоняется, то есть заносится в вектор отклоненных транзакций. Иначе транзакция признается корректной и заносится в итоговый вектор для commit. После каждого добавления транзакции проверяется, что на данный момент в итоговом векторе транзакций не больше, чем разрешено(специальное значение max_count), в противном случае цикл останавливается. После того, как в итоговый веткор набралось достаточное количество корректных транзакций, некорректные транзакции удаляются из пула и из списка непотраченных выходов. Потом итоговый вектор отправляется на commit.

Последняя часть заключается в правильном commit транзакций в mod.rs. После того как транзакции были выполены (произшел execute), надо отредактировать список неиспользованных выходов, чтобы он оставался корректен. Для этого по хэшу запрашивается транзакция, если транзакция 0 или 3 типа, то извлекаются хэши тех транзакций, которые используются. Они удаляются из списка неиспользованных выходов и сама транзакция удаляется из пула. В противном случае, транзакция просто удаляется из пула.

На данный момент, транзакции, которые были признаны некорректными удаляются совсем, то есть поиск по их хэшу не даёт ничего. 

